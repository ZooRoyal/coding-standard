---
name: Continuous Integration

on: pull_request

jobs:
  codestyle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-codestyle-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-codestyle-${{ env.cache-name }}-
            ${{ runner.os }}-codestyle-
            ${{ runner.os }}-

      - name: Cache Composer Packages
        uses: actions/cache@v2
        env:
          cache-name: cache-composer
        with:
          path: ~/.composer
          key: ${{ runner.os }}-codestyle-${{ env.cache-name }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-codestyle-${{ env.cache-name }}-
            ${{ runner.os }}-codestyle-
            ${{ runner.os }}-

      - name: Setup PHP and Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools:  cs2pr, composer
        env:
          fail-fast: true

      - name: Install npm and Node
        uses: actions/setup-node@v1
        with:
          node-version: '10.19.0'

      - name: Install composer dependencies
        env:
          COMPOSER_PARAMETERS: ${{ matrix.composer_parameters }}
        run: |
          composer install
          composer show -i

      - name: Check Coding-Standard
        run : |
          set +e
          src/bin/coding-standard sca:all
          CS_EXIT=$?
          trap "cs2pr /tmp/checkstyle" EXIT
          exit $CS_EXIT

  tests:
    runs-on: ubuntu-latest
    needs:
      - codestyle
    strategy:
      matrix:
        composer_version: [1,2]
        composer_parameters: ['--prefer-lowest', ' ']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-tests-${{ env.cache-name }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-tests-${{ env.cache-name }}-
            ${{ runner.os }}-tests-
            ${{ runner.os }}-

      - name: Cache Composer Packages
        uses: actions/cache@v2
        env:
          cache-name: cache-composer-${{ matrix.composer_version }}-${{ matrix.composer_parameters }}
        with:
          path: ~/.composer
          key: ${{ runner.os }}-tests-${{ env.cache-name }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-tests-${{ env.cache-name }}-
            ${{ runner.os }}-tests-
            ${{ runner.os }}-

      - name: Setup PHP and Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools:  cs2pr, composer:${{ matrix.composer_version }}
          extensions: xdebug-2.9.8
        env:
          fail-fast: true

      - name: Install npm and Node
        uses: actions/setup-node@v1
        with:
          node-version: '10.19.0'

      - name: Install composer dependencies
        env:
          COMPOSER_PARAMETERS: ${{ matrix.composer_parameters }}
        run: |
          composer update -n --no-progress ${COMPOSER_PARAMETERS}
          composer show -i

      - name: Check PHPUnit
        run : |
          $(composer config bin-dir)/phpunit

      - name: Check infections
        run : |
          $(composer config bin-dir)/infection -n --min-msi=81 --min-covered-msi=82 --threads=4

